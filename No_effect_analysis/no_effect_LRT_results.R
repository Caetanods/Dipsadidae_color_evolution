## This is the results of the no_effect_LRT_analysis.R
## I am going to compare the distribution of likelihood ratios for the constrained and the
##      full model of 100 datasets simulated under both the constrained and full model
##      parameter estimates.
## This version of the analysis DO NOT integrate phylogenetic uncertainty, since it is
##      only the result for the first tree sampled from the posterior distribution
##      generated by the BiSSE analysis.

## Load results.
files <- dir("./no-effect-results/LRT_results/", pattern = "*.RData")
for(i in files) load(paste("./no-effect-results/LRT_results/", i, sep = ""))

## Calculate p value for the empirical dataset:
lik.emp.fit.full <- emp.fit.full$MLE$lnLik
lik.emp.fit.cons <- emp.fit.cons$MLE$lnLik
D.emp <- -2 * lik.emp.fit.cons + 2 * lik.emp.fit.full
p.emp <- 1 - pchisq(D.emp, df = 2)

## Get the distribution of LRT for the data simulated under the constrained model:
lik.cons.fit.cons <- sapply(mle.cons.fit.cons, function(x) x$MLE$lnLik)
lik.cons.fit.full <- sapply(mle.cons.fit.full, function(x) x$MLE$lnLik)
D.cons <- -2 * lik.cons.fit.cons + 2 * lik.cons.fit.full
p.cons <- 1 - pchisq(D.cons, df = 2)

## Get the distribution of LRT for the data simulated under the full model:
lik.full.fit.cons <- sapply(mle.full.fit.cons, function(x) x$MLE$lnLik)
lik.full.fit.full <- sapply(mle.full.fit.full, function(x) x$MLE$lnLik)
D.full <- -2 * lik.full.fit.cons + 2 * lik.full.fit.full
p.full <- 1 - pchisq(D.full, df = 2)

## Make plot:
mn <- min(c(p.cons,p.full))
mx <- max(c(p.cons,p.full))
plot(density(p.full, from = mn, to = mx), xlim = c(mn,mx), col = "red")
lines(density(p.cons, from = mn, to = mx), col = "blue")
abline(v = p.emp)

## Get the two sided 0.05% threshould of p.values under both constrained and full simulations:
qq.cons <- quantile(p.cons, probs = c(0.025, 0.975) )
qq.full <- quantile(p.full, probs = c(0.025, 0.975) )
p.emp < qq.cons[1]
p.emp < qq.full[1]
p.emp
round(qq.cons, 10)
round(qq.full, 9)
